language: objective-c

before_install:
# - brew tap caskroom/versions
# - brew cask install java8
# - export JAVA_HOME=/Library/Java/JavaVirtualMachines/jdk1.8.0_202.jdk/Contents/Home
- echo $JAVA_HOME
- ls -la /Library/Java/JavaVirtualMachines
- wget http://dl.google.com/android/android-sdk_r24.4.1-macosx.zip
- unzip android-sdk_r24.4.1-macosx.zip
- export ANDROID_HOME=$PWD/android-sdk-macosx
- export PATH=${PATH}:${ANDROID_HOME}/tools:${ANDROID_HOME}/platform-tools
- echo yes | android update sdk --filter platform-tools --no-ui --force > /dev/null
- echo yes | android update sdk --filter android-28 --no-ui --force > /dev/null
- echo yes | android update sdk --filter build-tools-28.0.3 --all --no-ui --force > /dev/null
- echo yes | android update sdk --filter sysimg-27 --no-ui --force > /dev/null
- echo yes | android update sdk --filter extra-android-support --no-ui --force > /dev/null
- echo yes | android update sdk --filter extra-android-m2repository --no-ui --force > /dev/null

install:
  - nvm install 8.3 --reinstall-packages-from=node
  - npm install -g react-native-cli
  - gem install xcpretty

script:
  - react-native init AwesomeProject
  - cd AwesomeProject
  - npm install ../
  - react-native link
  - git apply ../misc/testfairy.patch
  - cd android
  - ./gradlew assembleDebug
  - cd ../ios
  - xcrun xcodebuild -project AwesomeProject.xcodeproj -scheme AwesomeProject -configuration Debug CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO | xcpretty

before_deploy:
  - cd ../..
  - rm -rf AwesomeProject
  - sed -i'' "s/\"version\":.*/\"version\":\"${TRAVIS_TAG}\",/g" package.json

deploy:
  provider: npm
  email: support@testfairy.com
  api_key:
    secure: vIrxQligyqJMwKK34fD9OjsAyeEvJjYN9bT2l8WEc+GfXNK1LQpxhznONP6vJVOAIw7oNQwoyRdjYtMKqk1wUOx0tQ3tPDgsfIcrHGBlII7tUpWQpKGahXvKmu8wInu6CtYX5QWm9FJcDS/UOsW7MBF/kp2lKS0z5HScHVYV2ZjMQm/cFNgqagui5JxOtb+YyY1NLVac1CibHUf2D8za4HjffWeS+r6xgZ9Lglq4YwVS3MZZFKeC7FwoK4MdATVaj8QUNKbEXsaqVEZ4bm+92fNpMx4AjuWZCNqobo4JrTj710HTqz9c8EO3gueTjDH0CDxCzGONSYFTjF0vaAHvvGMNDK31069YCTuY7df+1BsqiBymouiwQ3XpmNYSkjYsV68mzpwT6pLS7j/kZpzH6UFk5UonZcx2HWRFMuZdauhciy+NwOSdLHOV9S12kHWjtsKjUuIsYDhJqQ6EeAf59SLMW4QNmVaoLr7Np75AruZG5LP7oqfTSHWQHgj+WkObJJprWn3uNvCO8ygtA82BCnsYKM4t072DO+LmNu4h8jQtB+8vhgfjjkdGlM6n1r7q59uLLXorq+Oy/PLbnYy+zvdBDUWOtYSs0Ad2xvi6Y3e4kJZLYMvds2XT6xFfh1KBclBXZiXrN5Duna6OBETU5bwNxsGkxyuz/vdcU1ANb54=
  on:
    tags: true
    repo: testfairy/react-native-testfairy
